var timeout_geo=null;
function photo_geo_edit_meta(f){timeout_geo&&clearTimeout(timeout_geocontext);var j=$("#edit_geo").attr("geo:context"),g={0:"in a place that doesn't matter (not defined)",1:"indoors",2:"outdoors"},a='<div id="modal_geo">';a='<form id="photo_geo_update_context">';a+="<h3>Edit the geo context for this photo</h3>";a+="This photo was taken ";a+='<select id="new_geocontext">';for(i in g){a+='<option value="'+i+'"';if(i==j)a+=' selected="true" disabled="true"';a+=">"+g[i]+"</option>"}a+="</select>";a+=
"&#160;";a+='<input type="submit" value="UPDATE" />';a+="</form>";var m=$("#geo_placename a").html();a+='<div id="photo_geo_corrections">';a+="<h3>Edit the place name for this photo</h3>";a+="<p>Flickr thinks this photo was taken in <q>";a+=m;a+='</q>. <a href="#" id="photo_geo_corrections_fetch">Fetch the list of alternate place names.</a>';a+="</p>";a+="</div>";a+="</div>";a+='<div id="photo_geo_status"></div>';a+='<div id="photo_geo_close"><a href="#" onclick="$.modal.close(); return false;">close</a></div>';
$.modal(a);$("#photo_geo_corrections_fetch").click(function(){$.ajax({url:"/api/",type:"GET",data:{method:"flickr.photos.geo.possibleCorrections",photo_id:f,place_type:"neighbourhood"},success:function(c){$("#photo_geo_status").html("");if(c.stat!="ok")$("#photo_geo_status").html("Ack!");else{var b='<form id="photo_geo_corrections_update">';b+="It was really taken in ";b+='<select id="new_woeid">';b+="<option />";for(var d=c.places.length,e=0;e<d;e++){var k=c.places[e];b+='<option value="'+k.woeid+
'">'+k.name+"</option>"}b+="</select>";b+="&#160;&#160;";b+='<input type="submit" value="UPDATE" />';b+="</form>";$("#photo_geo_corrections").append(b);$("#photo_geo_corrections_update").submit(function(){var h=$("#new_woeid");h=h.val();$.ajax({url:"/api/",type:"POST",data:{method:"flickr.photos.geo.correctLocation",photo_id:f,woeid:h},success:function(l){$("#photo_geo_status").html(l.stat);console.log(l)}});$("#photo_geo_corrections_update").hide();$("#photo_geo_status").html("Poking the Flickr API...");
return false})}}});$("#photo_geo_corrections_fetch").hide();$("#photo_geo_status").html("Fetching alternate place names...")});$("#photo_geo_update_context").submit(function(){var c=$("#new_geocontext");c=c.val();if(c==j)alert("Hey! There's nothing to update!");else{$.ajax({url:"/api/",type:"POST",data:{method:"flickr.photos.geo.setContext",photo_id:f,context:c},success:function(b){if(b.stat!="ok")$("#photo_geo_status").html("Ack! There was a problem calling the Flickr API.");else{$("#edit_geo").attr("geo:context",
b.context);var d=g[b.context],e="";if(b.context!=0){b=$("#edit_geo").attr("geo:woeid");e='It was taken <a href="'+(places_url+b+"/"+d+"/")+'">'+d+"</a>"}$("#geo_context").html(e);d="<p>Success! The geo context for this photo has been updated and is now <strong>"+d+"</strong>.</p>";d+='<p style="font-style:italic;font-size:small;">This dialog will close itself automagically in a moment...</p>';$("#photo_geo_status").html(d);timeout_geocontext=setTimeout(function(){$.modal.close()},1E3)}}});$("#photo_geo_update_context").hide();
$("#photo_geo_status").html("Poking the Flickr API...");return false}})};
