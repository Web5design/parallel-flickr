<div class="photo_sidebar">

	{if $before|@count or $after|@count}
	<div class="photo_navi">

		<div class="photo_before">
		{if $before|@count}
		<a href="{$owner|@flickr_urls_photos_user}{$before.0.id|escape}" title="before: {$before.0.title|truncate:30:"..."|escape}"><img src="{$before.0|@flickr_urls_photo_thumb}" alt="{$before.0.title|escape}" onerror="this.src=abs_root_url + 'images/missing-n.png'; this.height=100; this.width=100;"/></a>
		{else}
		<img src="{$cfg.abs_root_url}images/youarehere.png" height="100" width="100" alt="you are here" />
		{/if}
		</div>

		<div class="photo_after">
		{if $after|@count}
		<a href="{$owner|@flickr_urls_photos_user}{$after.0.id|escape}" title="after: {$after.0.title|truncate:30:"..."|escape}"><img src="{$after.0|@flickr_urls_photo_thumb}" alt="{$after.0.title|escape}"  onerror="this.src=abs_root_url + 'images/missing-n.png'; this.height=100; this.width=100;"/></a>
		{else}
		<img src="{$cfg.abs_root_url}images/youarehere.png" height="100" width="100" alt="you are here" />
		{/if}
		</div>

		<br clear="all" />
	</div>	
	<!-- photo_navi -->
	{/if}

	<div class="photo_meta">
	{if !$is_own}

	<p>
	{if $photo.str_perms=='public'}
	This photo was taken by <a href="{$owner|@flickr_urls_photos_user}">{$owner.username|escape}</a> and <span class="hey-you" id="photo-perms">it is public</span>.
	{else}
	This photo was taken by <a href="{$owner|@flickr_urls_photos_user}">{$owner.username|escape}</a> and <span class="hey-you" id="photo-perms"> it can only be seen by {$photo.str_perms|escape}</span>.
	{/if}
	</p>

	{* all stuff that is assuming $is_own=1 now *}
	{else}


	{if !$photo|@flickr_photos_is_on_flickr}	
	<p>This photo is <strong>not on Flickr</strong>.</p>
	{/if}

	<p>
	{if $photo.str_perms=='public'}
	<a href="{$owner|@flickr_urls_photos_user}">You</a> took this photo and <span class="hey-you" id="photo-perms">it is <a href="{$owner|@flickr_urls_photos_user}public/">public</a></span>.
	{elseif $photo.str_perms=='private'}
	<a href="{$owner|@flickr_urls_photos_user}">You</a> took this photo and <span class="hey-you" id="photo-perms">it is <a href="{$owner|@flickr_urls_photos_user}private/">private</a></span>.
	{else}
	<a href="{$owner|@flickr_urls_photos_user}">You</a> took this photo and <span class="hey-you" id="photo-perms">it can only be seen by <a href="{$owner|@flickr_urls_photos_user}{$photo.str_perms|replace:" ":"-"|escape}/">{$photo.str_perms|escape}</a></span>.
	{/if}
	</p>

	<p>

	{if $photo.str_geoperms}

	{if $place}

	{if $photo.str_geoperms=='public'}
	This photo was taken in <span id="geo_placename">{if $cfg.enable_feature_solr and $cfg.enable_feature_places}<a	href="{$owner|@flickr_urls_photos_user}places/{$place.woeid|escape}">{$place.name|escape}</a>{else}{$place.name|escape}{/if}</span> and its location <span class="hey-you">is public</span>.
	{elseif $photo.str_geoperms=='private'}
	This photo was taken in <span id="geo_placename">{if $cfg.enable_feature_solr and $cfg.enable_feature_places}<a	href="{$owner|@flickr_urls_photos_user}places/{$place.woeid|escape}">{$place.name|escape}</a>{else}{$place.name|escape}{/if}<span> and its location <span class="hey-you">can only be seen by you</span>.
	{else}
	This photo was taken in <span id="geo_placename">{if $cfg.enable_feature_solr and $cfg.enable_feature_places}<a	href="{$owner|@flickr_urls_photos_user}places/{$place.woeid|escape}">{$place.name|escape}</a>{else}{$place.name|escape}{/if}</span> and its location <span class="hey-you">can only be seen by {$photo.str_geoperms|escape} and you</span>.
	{/if}

	{else}

	{if $photo.str_geoperms=='public'}
	This photo was taken in <span id="geo_placename">a place with no name</span> and its location <span class="hey-you">is public</span>.
	{elseif $photo.str_geoperms=='private'}
	This photo was taken in <span id="geo_placename">a place with no name</span> and its location <span class="hey-you">can only be seen by you</span>.
	{else}
	This photo was taken in <span id="geo_placename">{if $cfg.enable_feature_solr and $cfg.enable_feature_places}<a	href="{$owner|@flickr_urls_photos_user}places/{$place.woeid|escape}">{$place.name|escape}</a>{else} and its location <span class="hey-you">can only be seen by {$photo.str_geoperms|escape} and you</span>.
	{/if}

	{/if}

	{if $photo.hasgeo}
	<span id="geo_context">
	{if "solr"|@features_is_enabled and "places"|@features_is_enabled}

	{if $photo.geocontext==1}
	It was taken <a href="{$owner|@flickr_urls_photos_user}places/{$place.woeid|escape}/indoors/">indoors</a>.
	{elseif $photo.geocontext==2} It was taken <a href="{$owner|@flickr_urls_photos_user}places/{$place.woeid|escape}/outdoors/">outdoors</a>.
	{else}{/if}

	{else}

	{if $photo.geocontext==1}It was taken indoors.
	{elseif $photo.geocontext==2} It was taken outdoors.
	{else}{/if}

	{/if}
	</span>
	{/if}

	{/if}
	{/if}

	</p>

	<ul>
	<li>View <a href="{$photo|@flickr_urls_photo_original}">original photo</a>.</li>

	{if $photo|@flickr_photos_is_on_flickr}<li>View <a href="{$photo|@flickr_urls_photo_page_flickr}" target="_flickr">photo on Flickr</a>.</li>{/if}

	{if $photo.hasexif}<li>View <a href="{$photo|@flickr_urls_photo_page}exif/">exif data</a>.</li>{/if}

	</ul>

	{if "photo_edit"|@features_is_enabled}
	<ul style="margin-top:2em; border-top:1px solid #ccc; padding-top:1em;">

	{if "photo_edit_permissions"|@features_is_enabled}
	<li>
		<a href="#edit-photo-confirm" role="button" class="xxx-btn" data-toggle="modal" title="edit the permissions for this photo" id="edit-photo" data-photo-id="{$photo.id|escape}" data-edit-crumb="{$perms_crumb|escape}">Edit photo permissions</a>

		<div id="edit-photo-confirm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

		<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myModalLabel">Update the permissions for this photo</h3>
		</div>

		{if !$has_write_token}

		{capture assign="redir"}{$photo|@flickr_urls_photo_page:"0"}#edit-perms{/capture}
		{include file="inc_flickr_photo_auth_request_write.txt" redir=$redir action="edit"}

		{else}

		<div class="modal-body">

			<div id="edit-photo-body">
			<select name="perms" id="edit-photo-perms">
			{foreach from=$perms_map item="label" key="id"}
				<option value="{$id|escape}"{if $id==$photo.perms} selected="true"{/if}>{$label|escape}</option>
			{/foreach}
			</select>
			</div>

			<div class="progress progress-striped active" id="edit-photo-progress" style="display:none;">
			<div class="bar" style="width: 100%;"></div>
			</div>

		{* TO DO: geo perms *}

		</div>

		<div class="modal-footer" id="edit-photo-footer">
			<button class="btn" data-dismiss="modal" id="edit-photo-dismiss" aria-hidden="true">Actually, never mind</button>
			<button class="btn btn-primary" id="edit-photo-go">Make it so</button>
		</div>

		</div>

		<script type="text/javascript">
		{literal}

		$("#edit-photo-go").click(function(e){

			var method = 'parallel.flickr.photos.setPerms';

			var e = $("#edit-photo");
			var photo_id = e.attr("data-photo-id");
			var crumb = e.attr("data-edit-crumb");

			var perms = $("#edit-photo-perms");
			perms = perms.val();

			var args = {
				'id': photo_id,
				'crumb': crumb,
				'perms': perms,
			};

			var onsuccess = function(rsp){

				if (rsp['stat'] != 'ok'){

					var err = '<p class="alert alert-error">';
					err += 'Hrmmm. The API is reporting a problem updating your photo: ';
					err += htmlspecialchars(rsp['error']['error']);
					err += '</p>';

					$("#edit-photo-body").html(err);

					$("#edit-photo-progress").hide();
					$("#edit-photo-body").show();

					setTimeout(function(){
						$("#edit-photo-confirm").modal('hide');
					}, 8000);

					return;
				}

				var feedback = '<p class="alert alert-success">';
				feedback += 'Okay! Your photo permissions have been updated.';
				feedback += '</p>';

				$("#edit-photo-body").html(feedback);

				$("#edit-photo-progress").hide();
				$("#edit-photo-body").show();

				var perms = rsp['permissions']['id'];
				var label = rsp['permissions']['label'];
				var url = rsp['permissions']['url'];

				// FIX ME... this is risky (20130728/straup)
				var link = '<a href="' + url + '">' + htmlspecialchars(label) + '</a>';

				var seenby = "it can only be seen by " + link;

				if ((perms==0) || (perms==5)){
					seenby = "it is " + link;
				}

				$("#photo-perms").html(seenby);

				setTimeout(function(){
					$("#edit-photo-confirm").modal('hide');
				}, 2000);
			};

			var onerror = function(rsp){

				var err = '<p class="alert alert-error">';
				err += 'Ack! There was a problem calling the API.';
				err += '</p>';

				$("#edit-photo-body").html(err);
				$("#edit-photo-progress").hide();
				$("#edit-photo-body").show();

				setTimeout(function(){
					$("#edit-photo-confirm").modal('hide');
				}, 8000);

			};

			parallel_flickr_api_call(method, args, onsuccess, onerror);

			$("#edit-photo-body").hide();
			$("#edit-photo-footer").hide();
			$("#edit-photo-progress").show();
		});

		{/literal}
		</script>

		{/if}

	</li>
	{/if}

	{if $photo.has_geo and "photo_edit_geo"|@features_is_enabled}
	<li class="feature-disabled">Edit geo</li>
	{/if}

	{if "photo_edit_delete"|@features_is_enabled}
	<li>

		<a href="#delete-photo-confirm" role="button" class="btn" data-toggle="modal" title="delete this photo" id="delete-photo" data-photo-id="{$photo.id|escape}" data-delete-crumb="{$delete_crumb|escape}">Delete this photo</a>

		<div id="delete-photo-confirm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">

		{if !$has_delete_token}

		{capture assign="redir"}{$photo|@flickr_urls_photo_page:"0"}#delete{/capture}
		{include file="inc_flickr_photo_auth_request_delete.txt" redir=$redir}

		{else}

		<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		<h3 id="myModalLabel">Delete this photo?</h3>
		</div>

		<div class="modal-body">
		{* show thumbnail here *}
		<p>There is no undo.</p>
		</div>

		<div class="modal-footer">
		<button class="btn" data-dismiss="modal" aria-hidden="true">No, thanks</button>
		<button class="btn btn-primary" id="delete-photo-go">Yes please</button>
		</div>

		<script type="text/javascript">
		{literal}

		$("#delete-photo-go").click(function(e){

			var method = 'parallel.flickr.photos.delete';

			var d = $("#delete-photo");
			var crumb = d.attr("data-delete-crumb");

			var args = {
				'id': photo_id,
				'crumb': crumb,
			};

			var onsuccess = function(rsp){
				console.log(rsp);
			};

			var onerror = function(rsp){
				console.log("ERROR");
				console.log(rsp);
			};

			parallel_flickr_api_call(method, args, onsuccess, onerror);

			$("#delete-photo-confirm").modal('hide');

			// hide or disabled the delete button...
			// some kind of dialog...
		});

		{/literal}
		</script>

		{/if}

		</div>
	</li>
	{/if}

	</ul>
	{/if}

	{/if}

	<!-- photo_meta -->

	{* this is not working because ... uh? bootstraup maybe? *}
	{if 0}{include file="inc_flickr_photo_map.txt"}{/if}

	<br clear="all" />

</div>
